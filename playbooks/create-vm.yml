---
- name: Create a Linux VM in Azure
  hosts: localhost
  connection: local
  gather_facts: no

  collections:
    - azure.azcollection

  vars:
    resource_group: "RG-Groupe6v2"
    location: "polandcentral"
    vm_name: "vm-demo"
    admin_username: "azureuser"
    admin_password: "Password1234!"

  tasks:

    - name: Create virtual network
      azure.azcollection.azure_rm_virtualnetwork:
        resource_group: "{{ resource_group }}"
        name: "vnet-{{ vm_name }}"
        address_prefixes: "10.0.0.0/16"

    - name: Create subnet
      azure.azcollection.azure_rm_subnet:
        resource_group: "{{ resource_group }}"
        name: "subnet-{{ vm_name }}"
        address_prefix: "10.0.1.0/24"
        virtual_network: "vnet-{{ vm_name }}"

    - name: Create Public IP (Standard SKU)
      azure.azcollection.azure_rm_publicipaddress:
        resource_group: "{{ resource_group }}"
        name: "pip-{{ vm_name }}"
        allocation_method: Static
        sku: Standard

    # ---------------------------------------
    # NSG + r√®gle port 8080
    # ---------------------------------------

    - name: Create Network Security Group with rules
      azure.azcollection.azure_rm_securitygroup:
        resource_group: "{{ resource_group }}"
        name: "nsg-{{ vm_name }}"
        location: "{{ location }}"
        rules:
          - name: allow_8080
            protocol: Tcp
            direction: Inbound
            access: Allow
            priority: 1001
            source_address_prefix: "*"
            destination_address_prefix: "*"
            destination_port_range: 8080
          - name: allow_ssh
            protocol: Tcp
            direction: Inbound
            access: Allow
            priority: 1000
            source_address_prefix: "*"
            destination_address_prefix: "*"
            destination_port_range: 22


    # ---------------------------------------
    # NIC + association NSG
    # ---------------------------------------

    - name: Create network interface with public IP + NSG
      azure.azcollection.azure_rm_networkinterface:
        resource_group: "{{ resource_group }}"
        name: "nic-{{ vm_name }}"
        virtual_network: "vnet-{{ vm_name }}"
        subnet_name: "subnet-{{ vm_name }}"
        security_group: "nsg-{{ vm_name }}"
        ip_configurations:
          - name: "ipconfig1"
            public_ip_address_name: "pip-{{ vm_name }}"

    - name: Create Linux VM with Managed Disk
      azure.azcollection.azure_rm_virtualmachine:
        resource_group: "{{ resource_group }}"
        name: "{{ vm_name }}"
        location: "{{ location }}"
        vm_size: "Standard_B2ats_v2"
        admin_username: "{{ admin_username }}"
        admin_password: "{{ admin_password }}"
        network_interfaces: "nic-{{ vm_name }}"
        image:
          offer: "ubuntu-24_04-lts"
          publisher: Canonical
          sku: server
          version: latest
        managed_disk_type: Standard_LRS
