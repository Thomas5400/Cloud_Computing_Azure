---
- name: Deploy 2048 game on Azure VM with Docker
  hosts: all
  become: yes #on fait un sudo pour les taches locales
 

  collections:
    - community.docker

  tasks:

    # -------------------------------
    # UPDATE AND INSTALL PREREQUISITES
    # -------------------------------
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - git
        state: present

    - name: Install Docker CE
      apt:
        name:
          - docker.io         
        state: present
        update_cache: yes

    - name: Ensure Docker is running
      service:
        name: docker
        state: started
        enabled: yes




    # -------------------------------
    # BUILD DOCKER IMAGE
    # -------------------------------
    - name: Build Docker image for 2048
      docker_image:
        name: game2048
        tag: latest
        build:
          path: /opt/2048
        state: present
        force_source: yes
      register: docker_build

    # -------------------------------
    # STOP AND REMOVE OLD CONTAINER
    # -------------------------------
    - name: Stop existing 2048 container if it exists
      docker_container:
        name: game-2048
        state: stopped
      ignore_errors: yes

    - name: Remove existing 2048 container if it exists
      docker_container:
        name: game-2048
        state: absent
      ignore_errors: yes

    # -------------------------------
    # RUN NEW CONTAINER ON PORT 8080
    # -------------------------------
    - name: Run 2048 container on port 8080
      docker_container:
        name: game-2048
        image: game2048:latest
        state: started
        restart_policy: always
        ports:
          - "8080:80"
        env:
          TZ: "UTC"
      register: container_result

    # -------------------------------
    # DISPLAY DEPLOYMENT INFO
    # -------------------------------
    - name: Display deployment summary
      debug:
        msg: |
          ========================================
          2048 Game deployed successfully!
          ========================================
          Container Name: game-2048
          Container Image: game2048:latest
          Exposed Port: 8080 (internal port 80)
          Access URL: http://<your-vm-public-ip>:8080
          ========================================
